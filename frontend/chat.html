<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Chatterbox</title>
<script src="https://cdn.tailwindcss.com"></script>

<style>
.room-General,.room-Tech,.room-Fun{color:white}
.typing-dot{
  width:6px;height:6px;background:#10b981;border-radius:9999px;
  animation:bounce 1.4s infinite ease-in-out
}
.typing-dot:nth-child(2){animation-delay:.2s}
.typing-dot:nth-child(3){animation-delay:.4s}
@keyframes bounce{
  0%,80%,100%{transform:translateY(0)}
  40%{transform:translateY(-6px)}
}
</style>
</head>

<body class="bg-slate-100 h-screen flex items-center justify-center">

<div class="w-full max-w-3xl bg-white rounded-xl shadow-lg flex flex-col h-[90vh]">

<!-- HEADER -->
<div class="bg-gradient-to-r from-indigo-500 to-purple-600 text-white px-6 py-4 flex justify-between items-center relative">
  <h2 class="text-xl font-bold">ðŸ’¬ Chatterbox</h2>

  <button id="roomBtn" class="bg-white/20 px-4 py-2 rounded-full">
    <span id="roomLabel">General</span> âŒ„
  </button>

  <div id="roomMenu" class="hidden absolute right-6 top-16 bg-white rounded-lg shadow-lg w-40 text-slate-700">
    <div class="px-4 py-3 hover:bg-slate-100 cursor-pointer" data-room="General">General</div>
    <div class="px-4 py-3 hover:bg-slate-100 cursor-pointer" data-room="Tech">Tech</div>
    <div class="px-4 py-3 hover:bg-slate-100 cursor-pointer" data-room="Fun">Fun</div>
  </div>
</div>

<!-- MESSAGES -->
<div id="messages" class="flex-1 overflow-y-auto p-4 space-y-4">
  <div id="emptyState" class="text-center text-slate-500 text-sm">
    No messages yet. Start the conversation ðŸ‘‹
  </div>
</div>

<!-- TYPING -->
<div id="typing" class="px-4 h-6 text-slate-500"></div>

<!-- INPUT -->
<div class="p-4 border-t flex gap-2">
  <input id="input"
    class="flex-1 px-5 py-3 rounded-full bg-slate-100 focus:ring-2 focus:ring-indigo-400 outline-none"
    placeholder="Type a message...">
  <button onclick="sendMessage()"
    class="bg-indigo-600 text-white w-12 h-12 rounded-full">âž¤</button>
</div>

</div>

<script>
/* ================= SESSION ================= */
const username = sessionStorage.getItem("username");
let room = sessionStorage.getItem("room") || "General";

if (!username) {
  window.location.href = "index.html";
}
sessionStorage.setItem("room", room);

/* ================= STATE ================= */
const roomMessages = {};
const messages = document.getElementById("messages");
const input = document.getElementById("input");
const typingDiv = document.getElementById("typing");
const roomLabel = document.getElementById("roomLabel");
const roomMenu = document.getElementById("roomMenu");
const roomBtn = document.getElementById("roomBtn");

roomLabel.textContent = room;

/* ================= SOCKET ================= */
const WS_URL =
  location.hostname === "localhost"
    ? "ws://localhost:8000/ws"
    : "wss://chatterbox-kil7.onrender.com/ws";

const ws = new WebSocket(WS_URL);

ws.onopen = () => {
  ws.send(JSON.stringify({ username, room }));
};

ws.onmessage = (e) => {
  const data = JSON.parse(e.data);

  if (data.type === "chat") {
    removeEmpty();
    storeMessage(data.username, data.message, data.time);
    renderMessage(data.username, data.message, data.time);
  }

  if (data.type === "system") {
    renderSystem(data.message, data.time);
  }

  if (data.type === "typing" && data.username !== username) {
    typingDiv.innerHTML = `
      <span>${data.username} is typing</span>
      <span class="typing-dot"></span>
      <span class="typing-dot"></span>
      <span class="typing-dot"></span>`;
  }

  if (data.type === "stop_typing") {
    typingDiv.innerHTML = "";
  }
};

/* ================= ROOM SWITCH ================= */
roomBtn.onclick = () => roomMenu.classList.toggle("hidden");

roomMenu.querySelectorAll("div").forEach(item => {
  item.onclick = () => {
    room = item.dataset.room;
    sessionStorage.setItem("room", room);
    roomLabel.textContent = room;

    messages.innerHTML = "";
    typingDiv.innerHTML = "";
    loadRoomMessages();

    ws.send(JSON.stringify({ type: "switch_room", room }));
    roomMenu.classList.add("hidden");
  };
});

/* ================= FUNCTIONS ================= */
function sendMessage() {
  if (!input.value.trim()) return;

  ws.send(JSON.stringify({ type: "chat", message: input.value }));
  ws.send(JSON.stringify({ type: "stop_typing" }));
  input.value = "";
}

input.addEventListener("input", () => {
  ws.send(JSON.stringify({ type: "typing" }));
});

function storeMessage(user, text, time) {
  if (!roomMessages[room]) roomMessages[room] = [];
  roomMessages[room].push({ user, text, time });
}

function renderMessage(user, text, time) {
  const safeTime = time || new Date().toLocaleTimeString([], {
    hour: "2-digit",
    minute: "2-digit"
  });

  const div = document.createElement("div");
  div.className = user === username ? "text-right" : "text-left";

  div.innerHTML = `
    <div class="inline-block px-4 py-2 rounded-xl ${
      user === username ? "bg-indigo-500 text-white" : "bg-slate-200"
    }">
      <strong>${user}</strong>
      <span class="text-xs opacity-70 ml-2">${safeTime}</span><br>
      ${text}
    </div>`;
  messages.appendChild(div);
  scrollBottom();
}

function renderSystem(text, time) {
  const safeTime = time || new Date().toLocaleTimeString([], {
    hour: "2-digit",
    minute: "2-digit"
  });

  const div = document.createElement("div");
  div.className = "text-center text-xs text-slate-500";
  div.textContent = `${text} â€¢ ${safeTime}`;
  messages.appendChild(div);
  scrollBottom();
}

function loadRoomMessages() {
  if (!roomMessages[room] || roomMessages[room].length === 0) {
    messages.innerHTML = `<div id="emptyState" class="text-center text-slate-500 text-sm">
      No messages yet. Start the conversation ðŸ‘‹</div>`;
    return;
  }

  roomMessages[room].forEach(m =>
    renderMessage(m.user, m.text, m.time)
  );
}

function removeEmpty() {
  const e = document.getElementById("emptyState");
  if (e) e.remove();
}

function scrollBottom() {
  messages.scrollTo({ top: messages.scrollHeight, behavior: "smooth" });
}
</script>

</body>
</html>
