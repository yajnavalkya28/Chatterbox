<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Chatterbox</title>
<script src="https://cdn.tailwindcss.com"></script>

<style>
.room-General,.room-Tech,.room-Fun{color:white}

.typing-wrapper{display:flex;align-items:center;gap:8px}
.typing-dots{display:flex;gap:4px}

.typing-dot{
  width:6px;height:6px;background:#10b981;border-radius:9999px;
  animation:typingBounce 1.4s infinite ease-in-out;
}
.typing-dot:nth-child(2){animation-delay:.2s}
.typing-dot:nth-child(3){animation-delay:.4s}

@keyframes typingBounce{
  0%,80%,100%{transform:translateY(0);opacity:.4}
  40%{transform:translateY(-6px);opacity:1}
}
</style>
</head>

<body class="bg-slate-100 h-screen flex items-center justify-center">

<div class="w-full max-w-3xl bg-white rounded-xl shadow-lg flex flex-col h-[90vh]">

<!-- HEADER -->
<div class="bg-gradient-to-r from-indigo-500 to-purple-600 text-white px-6 py-4 flex justify-between items-center relative">
  <h2 class="text-xl font-bold">ðŸ’¬ Chatterbox</h2>

  <button id="roomBtn" class="bg-white/20 px-4 py-2 rounded-full">
    <span id="roomLabel">General</span> âŒ„
  </button>

  <div id="roomMenu" class="hidden absolute right-6 top-16 bg-white rounded-lg shadow-lg w-40 text-slate-700">
    <div class="px-4 py-3 hover:bg-slate-100 cursor-pointer" data-room="General">General</div>
    <div class="px-4 py-3 hover:bg-slate-100 cursor-pointer" data-room="Tech">Tech</div>
    <div class="px-4 py-3 hover:bg-slate-100 cursor-pointer" data-room="Fun">Fun</div>
  </div>
</div>

<!-- ONLINE USERS -->
<div id="onlineBar" class="hidden px-4 py-3 bg-slate-50 flex items-center justify-between border-b">
  <div id="avatars" class="flex -space-x-2"></div>
  <span id="memberCount" class="text-sm text-slate-500"></span>
</div>

<!-- MESSAGES -->
<div id="messages" class="flex-1 overflow-y-auto p-4 space-y-4">
  <div id="emptyState" class="text-center text-slate-500 text-sm">
    No messages yet. Start the conversation ðŸ‘‹
  </div>
</div>

<!-- TYPING -->
<div id="typing" class="px-4 h-7 text-slate-500"></div>

<!-- INPUT -->
<div class="p-4 border-t flex gap-2">
  <input id="input"
    class="flex-1 px-5 py-3 rounded-full bg-slate-100 focus:ring-2 focus:ring-indigo-400 outline-none"
    placeholder="Type a message...">
  <button onclick="sendMessage()"
    class="bg-indigo-600 text-white w-12 h-12 rounded-full">âž¤</button>
</div>

</div>

<script>
/* ================= SESSION ================= */
const username = sessionStorage.getItem("username");
let room = sessionStorage.getItem("room") || "General";
if (!username) location.href = "index.html";
sessionStorage.setItem("room", room);

/* ================= STATE ================= */
const messagesDiv = document.getElementById("messages");
const input = document.getElementById("input");
const typingDiv = document.getElementById("typing");
const roomLabel = document.getElementById("roomLabel");
const roomMenu = document.getElementById("roomMenu");
const roomBtn = document.getElementById("roomBtn");

const onlineBar = document.getElementById("onlineBar");
const avatarsDiv = document.getElementById("avatars");
const memberCount = document.getElementById("memberCount");

roomLabel.textContent = room;

const roomMessages = JSON.parse(sessionStorage.getItem("roomMessages")) || {};

/* ===== REAL-TIME TYPING STATE ===== */
let typingInterval = null;

/* ================= SOCKET ================= */
const WS_URL =
  location.hostname === "localhost"
    ? "ws://localhost:8000/ws"
    : "wss://chatterbox-kil7.onrender.com/ws";

const ws = new WebSocket(WS_URL);

ws.onopen = () => {
  ws.send(JSON.stringify({ username, room }));
};

ws.onmessage = (e) => {
  const data = JSON.parse(e.data);

  if (data.type === "chat") {
    storeMessage(room, { kind:"chat", user:data.username, text:data.message, time:data.time });
    renderChat(data.username, data.message, data.time);
  }

  if (data.type === "system") {
    storeMessage(room, { kind:"system", text:data.message, time:data.time });
    renderSystem(data.message, data.time);
  }

  if (data.type === "users") {
    updateUsers(data.users);
  }

  if (data.type === "typing" && data.username !== username) {
    showTyping(data.username);
  }

  if (data.type === "stop_typing") {
    hideTyping();
  }
};

/* ================= INPUT EVENTS (REAL-TIME) ================= */
input.addEventListener("input", () => {
  const hasText = input.value.trim().length > 0;

  if (hasText && !typingInterval) {
    ws.send(JSON.stringify({ type: "typing" }));

    typingInterval = setInterval(() => {
      ws.send(JSON.stringify({ type: "typing" }));
    }, 500); // heartbeat
  }

  if (!hasText && typingInterval) {
    clearInterval(typingInterval);
    typingInterval = null;
    ws.send(JSON.stringify({ type: "stop_typing" }));
  }
});

input.addEventListener("keydown", (e) => {
  if (e.key === "Enter") {
    e.preventDefault();
    sendMessage();
  }
});

/* ================= ROOM SWITCH ================= */
roomBtn.onclick = () => roomMenu.classList.toggle("hidden");

roomMenu.querySelectorAll("div").forEach(item => {
  item.onclick = () => {
    room = item.dataset.room;
    sessionStorage.setItem("room", room);
    roomLabel.textContent = room;

    messagesDiv.innerHTML = "";
    hideTyping();
    onlineBar.classList.add("hidden");
    renderRoomMessages(room);

    ws.send(JSON.stringify({ type: "switch_room", room }));
    roomMenu.classList.add("hidden");
  };
});

/* ================= FUNCTIONS ================= */
function updateUsers(users) {
  avatarsDiv.innerHTML = "";
  if (!users || users.length === 0) {
    onlineBar.classList.add("hidden");
    return;
  }
  onlineBar.classList.remove("hidden");

  users.forEach(u => {
    const a = document.createElement("div");
    a.className =
      "w-8 h-8 bg-indigo-500 text-white rounded-full flex items-center justify-center text-xs font-bold border-2 border-white";
    a.textContent = u[0].toUpperCase();
    avatarsDiv.appendChild(a);
  });

  memberCount.textContent = users.length + " member" + (users.length>1?"s":"");
}

function sendMessage() {
  if (!input.value.trim()) return;

  ws.send(JSON.stringify({ type:"chat", message:input.value }));

  if (typingInterval) {
    clearInterval(typingInterval);
    typingInterval = null;
    ws.send(JSON.stringify({ type:"stop_typing" }));
  }

  input.value = "";
}

function storeMessage(room, msg) {
  if (!roomMessages[room]) roomMessages[room] = [];
  roomMessages[room].push(msg);
  sessionStorage.setItem("roomMessages", JSON.stringify(roomMessages));
}

function renderChat(user, text, time) {
  removeEmpty();
  const div = document.createElement("div");
  div.className = user === username ? "text-right" : "text-left";
  div.innerHTML = `
    <div class="inline-block px-4 py-2 rounded-xl ${
      user === username ? "bg-indigo-500 text-white" : "bg-slate-200"
    }">
      <strong>${user}</strong>
      <span class="text-xs opacity-70 ml-2">${time || currentTime()}</span><br>
      ${text}
    </div>`;
  messagesDiv.appendChild(div);
  scrollBottom();
}

function renderSystem(text, time) {
  removeEmpty();
  const div = document.createElement("div");
  div.className = "text-center text-xs text-slate-500";
  div.textContent = `${text} â€¢ ${time || currentTime()}`;
  messagesDiv.appendChild(div);
  scrollBottom();
}

function renderRoomMessages(room) {
  if (!roomMessages[room] || roomMessages[room].length === 0) {
    messagesDiv.innerHTML =
      `<div id="emptyState" class="text-center text-slate-500 text-sm">
        No messages yet. Start the conversation ðŸ‘‹
      </div>`;
    return;
  }
  roomMessages[room].forEach(m =>
    m.kind === "chat"
      ? renderChat(m.user, m.text, m.time)
      : renderSystem(m.text, m.time)
  );
}

function showTyping(user) {
  typingDiv.innerHTML = `
    <div class="typing-wrapper">
      <span>${user} is typing</span>
      <div class="typing-dots">
        <span class="typing-dot"></span>
        <span class="typing-dot"></span>
        <span class="typing-dot"></span>
      </div>
    </div>`;
}

function hideTyping() {
  typingDiv.innerHTML = "";
}

function removeEmpty() {
  const e = document.getElementById("emptyState");
  if (e) e.remove();
}

function scrollBottom() {
  messagesDiv.scrollTo({ top: messagesDiv.scrollHeight, behavior: "smooth" });
}

function currentTime() {
  return new Date().toLocaleTimeString([], { hour:"2-digit", minute:"2-digit" });
}

renderRoomMessages(room);
</script>

</body>
</html>
