<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Chatterbox</title>
<script src="https://cdn.tailwindcss.com"></script>

<style>
.room-General,
.room-Tech,
.room-Fun {
  color: white;
}

.typing-dot {
  width: 6px;
  height: 6px;
  background: #10b981;
  border-radius: 9999px;
  animation: bounce 1.4s infinite ease-in-out;
}

.typing-dot:nth-child(2) { animation-delay: 0.2s; }
.typing-dot:nth-child(3) { animation-delay: 0.4s; }

@keyframes bounce {
  0%, 80%, 100% { transform: translateY(0); }
  40% { transform: translateY(-6px); }
}
</style>
</head>

<body class="bg-slate-100 h-screen flex items-center justify-center">

<div class="w-full max-w-3xl bg-white rounded-xl shadow-lg flex flex-col h-[90vh]">

<!-- HEADER -->
<div class="bg-gradient-to-r from-indigo-500 to-purple-600 text-white px-6 py-4 flex justify-between items-center relative">
  <h2 class="text-xl font-bold">ðŸ’¬ Chatterbox</h2>

  <button id="roomBtn" class="flex items-center gap-2 bg-white/20 px-4 py-2 rounded-full">
    <span id="roomLabel" class="font-semibold">General</span> âŒ„
  </button>

  <div id="roomMenu" class="hidden absolute right-6 top-16 bg-white rounded-lg shadow-lg w-40 text-slate-700">
    <div class="px-4 py-3 hover:bg-slate-100 cursor-pointer" data-room="General">ðŸ’¬ General</div>
    <div class="px-4 py-3 hover:bg-slate-100 cursor-pointer" data-room="Tech">ðŸ’» Tech</div>
    <div class="px-4 py-3 hover:bg-slate-100 cursor-pointer" data-room="Fun">ðŸŽ‰ Fun</div>
  </div>
</div>

<!-- ONLINE USERS -->
<div id="onlineBar" class="hidden px-4 py-3 bg-slate-50 flex items-center justify-between">
  <div id="avatars" class="flex -space-x-2"></div>
  <span id="memberCount" class="text-sm text-slate-500"></span>
</div>

<!-- MESSAGES -->
<div id="messages" class="flex-1 overflow-y-auto p-4 space-y-4">
  <div id="emptyState" class="text-center text-slate-500 text-sm">
    No messages yet. Start the conversation ðŸ‘‹
  </div>
</div>

<!-- TYPING -->
<div id="typing" class="px-4 h-6 flex items-center gap-2 text-slate-500"></div>

<!-- INPUT -->
<div class="p-4 border-t bg-white flex gap-2 items-center">
  <input id="input"
    class="flex-1 px-5 py-3 rounded-full bg-slate-100 focus:outline-none focus:ring-2 focus:ring-indigo-400"
    placeholder="Type a message...">
  <button onclick="sendMessage()"
    class="bg-gradient-to-r from-indigo-500 to-purple-600 text-white w-12 h-12 rounded-full flex items-center justify-center shadow-lg hover:scale-105 transition">
    âž¤
  </button>
</div>

</div>

<script>
/* ------------------ STATE ------------------ */
const roomMessages = {};
const messages = document.getElementById("messages");
const input = document.getElementById("input");
const typingDiv = document.getElementById("typing");
const avatars = document.getElementById("avatars");
const memberCount = document.getElementById("memberCount");
const onlineBar = document.getElementById("onlineBar");
const roomLabel = document.getElementById("roomLabel");
const roomBtn = document.getElementById("roomBtn");
const roomMenu = document.getElementById("roomMenu");

let username = sessionStorage.getItem("username");
let room = sessionStorage.getItem("room");

if (!username || !room) {
  window.location.href = "login.html";
}

updateRoomUI(room);

/* ------------------ SOCKET ------------------ */
const socket = new WebSocket("ws://localhost:8000/ws");

socket.onopen = () => {
  socket.send(JSON.stringify({ type: "join", username, room }));
};

socket.onmessage = (e) => {
  const data = JSON.parse(e.data);

  if (data.type === "chat") {
    removeEmpty();
    addMessage(data.username, data.message, data.timestamp);
  }

  if (data.type === "system") {
    addSystem(data.message, data.timestamp);
  }

  if (data.type === "users") {
    updateUsers(data.users);
  }

  if (data.type === "typing") {
    typingDiv.innerHTML = `
      <span>${data.username} is typing</span>
      <div class="flex gap-1">
        <span class="typing-dot"></span>
        <span class="typing-dot"></span>
        <span class="typing-dot"></span>
      </div>
    `;
  }

  if (data.type === "stop_typing") {
    typingDiv.innerHTML = "";
  }
};

/* ------------------ ROOM SWITCH ------------------ */
roomBtn.onclick = () => roomMenu.classList.toggle("hidden");

roomMenu.querySelectorAll("div").forEach(item => {
  item.onclick = () => {
    const newRoom = item.dataset.room;
    if (newRoom === room) return;

    room = newRoom;
    sessionStorage.setItem("room", room);
    updateRoomUI(room);
    loadRoomMessages();

    socket.send(JSON.stringify({ type: "switch_room", room }));
    roomMenu.classList.add("hidden");
  };
});

/* ------------------ FUNCTIONS ------------------ */
function updateRoomUI(name) {
  roomLabel.textContent = name;
  roomLabel.className = "font-semibold room-" + name;
}

function addMessage(user, text, time) {
  if (!roomMessages[room]) roomMessages[room] = [];
  roomMessages[room].push({ user, text, time });
  renderMessage(user, text, time);
}

function renderMessage(user, text, time) {
  const div = document.createElement("div");
  div.className = user === username ? "text-right" : "text-left";

  div.innerHTML = `
    <div class="inline-block px-4 py-2 rounded-xl ${
      user === username ? "bg-indigo-500 text-white" : "bg-slate-200"
    }">
      <strong>${user}</strong>
      <span class="text-xs opacity-70 ml-2">${formatTime(time)}</span><br>
      ${text}
    </div>
  `;
  messages.appendChild(div);
  scrollToBottom();
}

function addSystem(text, time) {
  const div = document.createElement("div");
  div.className = "text-center text-xs text-slate-500";
  div.textContent = `${text} â€¢ ${formatTime(time)}`;
  messages.appendChild(div);
  scrollToBottom();
}

function loadRoomMessages() {
  messages.innerHTML = "";
  typingDiv.innerHTML = "";
  onlineBar.classList.add("hidden");

  if (!roomMessages[room] || roomMessages[room].length === 0) {
    messages.innerHTML = `<div id="emptyState" class="text-center text-slate-500 text-sm">
      No messages yet. Start the conversation ðŸ‘‹
    </div>`;
    return;
  }

  roomMessages[room].forEach(m =>
    renderMessage(m.user, m.text, m.time)
  );
}

function removeEmpty() {
  const e = document.getElementById("emptyState");
  if (e) e.remove();
}

function updateUsers(users) {
  avatars.innerHTML = "";
  if (!users.length) {
    onlineBar.classList.add("hidden");
    return;
  }

  onlineBar.classList.remove("hidden");
  users.forEach(u => {
    const a = document.createElement("div");
    a.className = "w-8 h-8 bg-indigo-500 text-white rounded-full flex items-center justify-center text-xs font-bold border-2 border-white";
    a.textContent = u[0].toUpperCase();
    avatars.appendChild(a);
  });

  memberCount.textContent = users.length + " members";
}

function sendMessage() {
  const text = input.value.trim();
  if (!text) return;

  socket.send(JSON.stringify({ type: "chat", message: text }));
  socket.send(JSON.stringify({ type: "stop_typing" }));
  input.value = "";
}

input.addEventListener("input", () => {
  socket.send(JSON.stringify({ type: "typing" }));
});

function formatTime(iso) {
  return new Date(iso).toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" });
}

function scrollToBottom() {
  messages.scrollTo({ top: messages.scrollHeight, behavior: "smooth" });
}
</script>

</body>
</html>
